### profile level tune
[H264的编码profile与level](https://www.cnblogs.com/tinywan/p/6402007.html)
#### 4种profile
H.264有四种画质级别,分别是baseline, extended, main, high： 
　　1、Baseline Profile：基本画质。支持I/P 帧，只支持无交错（Progressive）和CAVLC； 
　　2、Extended profile：进阶画质。支持I/P/B/SP/SI 帧，只支持无交错（Progressive）和CAVLC；(用的少) 
　　3、Main profile：主流画质。提供I/P/B 帧，支持无交错（Progressive）和交错（Interlaced）， 
　　　 也支持CAVLC 和CABAC 的支持； 
　　4、High profile：高级画质。在main Profile 的基础上增加了8x8内部预测、自定义量化、 无损视频编码和更多的YUV 格式；

### VFR（Variable Frame Rate可变帧率）与CFR（恒定帧率） 
[VFR介绍](http://avisynth.nl/index.php/VFR)
如果是静态帧，VFR对码率的优化会很明显。

### MB-Tree(Macroblock tree)
[参考资料](https://blog.csdn.net/zhoudegui88/article/details/80221765)

[论文---A novel macroblock-tree algorithm for high-performance optimization of
dependent video coding in H.264/AVC](https://huyunf.github.io/blogs/2017/12/06/x264_slice_type_decision/MBtree%20paper.pdf)

具体作用原理是：根据该MB在帧间预测中贡献给未来帧（在编码顺序里位于当前帧之后的帧）的信息，即被参考的情况，来调整该宏块的QP值。简言之，如果该MB贡献给后续帧的信息越多，则其重要性越高，应当提高该区域的编码质量，减少QP，反之，则增大该区域的QP。

要知道当前宏块对未来帧的贡献程度，则需要从未来帧反推有多少信息是来自于当前宏块的，由于未来帧还没有被编码，需要通过前向预测（lookahead）来进行预测。前向预测通过对一定数量的未编码帧做快速运动估计，对这些帧的编码代价进行预估。经过前向预测可以得到未编码帧的如下参数的估计值：

（1）      帧类型

（2）      每个宏块的类型和运动矢量

（3）      帧内编码和帧间编码的SATD值

MB-tree算法对于每个宏块计算了两个参数：
+ 遗传代价propagate cost。遗传代价表示了当前宏块贡献给未来帧的信息
+ 继承率propagate fraction。继承率代表当前宏块的信息有多少来自于参考帧。

x264源码中实现MB-tree的函数为x264_macroblock_tree，其中调用了如下三个函数来实现上述步骤：

（1）x264_slicetype_frame_cost( ): 计算宏块的帧内代价和帧间代价；

（2）x264_macroblock_tree_propagate ( ):计算当前宏块的遗传代价；

（3）x264_macroblock_tree_finish( ) : 计算量化参数偏移系数；

以下数值的计算方式：
+ 当前宏块的帧内代价intra cost
+ 当前宏块的帧间代价inter cost
+ 当前宏块的遗传代价propagate cost
+ 当前宏块的继承率propagate fraction
    > 假设一个宏块的inter cost只有intracost的80%，说明帧间预测节省了20% 的编码消耗，则该宏块的信息有20%来自于参考帧，propagate fraction为0.2
+ 当前宏块的继承自参考帧的信息量propagate amount
    > 当前宏块有关的所有信息总和大约为intra cost+ propagate cost（自身信息和提供给后续帧的信息）, 使用这个总和乘以继承率propagate fraction

### 支持的preset
 x264_preset_names[] = { "ultrafast", "superfast", "veryfast", "faster", "fast", "medium", "slow", "slower", "veryslow", "placebo", 0 };
 preset、tune都是用于为不同的应用场景预置了一套配置参数，可以通过设置preset、tune获取这个参数，然后再基于这组参数去修改具体的参数。
 
### Tune分类的特性
* **film** – 电影场景，intended for high-bitrate/high-quality movie content. Lower deblocking is used here.  
* **animation** – 动画片，矢量图片场景，intended for cartoons, etc., where deblocking is boosted to compensate for larger, flat areas. More reference frames are used.
* **grain** – 颗粒纹理场景，this should be used for material that is already grainy. Here, the grain won't be filtered out as much.
* **stillimage** – 静态图片，like the name says, it optimizes for still image encoding by lowering the deblocking filter.  
* **psnr and ssim** – these are debugging modes to optimize for good PSNR and SSIM values only. Better metrics don't necessarily mean better quality though.   
* **fastdecode** – 快速解码，disables CABAC and the in-loop deblocking filter to allow for faster decoding on devices with lower computational power.  
* **zerolatency** – 零延迟，optimization for fast encoding and low latency streaming
___

### 关于B帧
在设置Profile时，x264_param_apply_profile(pX264Param, profile);   
> x264_profile_names[0] ： baseline profile（不支持B帧功能）  
> x264_profile_names[1] ： main profile（支持B帧功能）
___
### 关于zerolatancy
在将tune==“zerolatancy"时：
> B帧为0时(x264Params.i_bframe=0)，没有帧延迟。第一帧编码后直接返回编码成功的H264帧
> B帧不为0时(x264Params.i_bframe=n n>0)，有n帧延迟。

___
### 编译以及调试
#### linux与mac
```
// cd 到x264根目录
// mac下不要使用avisynth读写文件，没有安装
./configure --disable-asm --enable-debug --enable-static --disable-avs

make

// make成功后在根目录下会有名为x264的可执行文件
// mac可以使用lldb进行调试
lldb -f x264

// 命令行
// 编码。注意：yuv文件的文件名是需要特定格式的字符串，包含分辨率和yuv格式
./x264 -o ~/DataForTest/cam_1280x720.264 ~/DataForTest/cam_1280x720_yuv420p.yuv
```
#### Windows
[Windows编译x264-使用MSYS2](https://blog.csdn.net/weixin_42147726/article/details/122970391)

___
### 模块与实现的文件
##### encoder api -- encoder.c
##### rate control码率控制 -- ratecontrol.c
##### 帧数据操作（复制等） -- frame.c
##### 向前侦测 -- lookahead.c

___
### 编码流程
1. ratecontrol--x264_adaptive_quant_frame
2. ratecontrol--ac_energy_mb--Find the total AC energy of the block in all planes.

___
### 参考资料
[x264命令行解释](https://www.jianshu.com/p/dea33a9ba070)